# WinLink Migrator 项目开发规范文档

## 1. 项目概况
WinLink 迁移器是一个 Windows 实用工具仪表盘，旨在帮助用户将应用程序数据从系统盘（C盘）迁移到其他分区，并通过创建符号链接（Symbolic Links / Junctions）保持原有路径的访问性。项目集成 Google Gemini AI，用于评估迁移操作的安全性。

目前版本为 Web POC (概念验证)，旨在展示 UI 交互、状态流转及 AI 集成，实际文件操作需要在 Tauri 环境下运行。

## 2. 技术栈架构
- 前端框架: React 19（react, react-dom）
- 开发语言: TypeScript
- 样式方案: Tailwind CSS (通过 CDN 引入)
- 图标库: Lucide React
- AI 服务：Google GenAI SDK（@google/genai - Gemini 1.5 闪光灯/专业版）
- 构建/运行环境: 浏览器(当前), 目标为 Tauri

### 2.1 建议与优化

#### 技术栈优化
- **Tailwind CSS**: 考虑从 CDN 引入改为 npm 安装配置，以便使用自定义主题和插件
- **状态管理**: 添加状态管理库（如 Zustand、Jotai 或 Redux Toolkit）以更好地管理应用状态
- **构建工具**: 使用 Vite 作为构建工具，提供更快的开发体验和构建速度
- **包管理器**: 考虑使用 pnpm 以提高依赖管理效率和减少磁盘占用
- **TypeScript 配置**: 配置更严格的 TypeScript 规则，提高代码质量
- **测试框架**: 添加测试框架（如 Vitest、React Testing Library）以确保代码质量
- **代码规范**: 集成 ESLint 和 Prettier 以保持代码风格一致性
- **CI/CD**: 添加 GitHub Actions 配置，实现自动化测试和构建

## 3. 核心数据模型(Type Definitions)
所有核心类型定义位于 types.ts。

### 3.1 应用状态流转 (应用状态）
应用在迁移过程中经历以下状态：
- 准备好: 就绪，等待操作。
- 分析: 正在进行 AI 安全分析。
- 移动: 正在执行迁移流程（包含细分步骤）。
- 已移动: 迁移及链接创建成功。
- 错误: 操作失败。

### 3.2 迁移细分步骤 (移动步）
当状态为移动时，UI 需展示具体的底层操作进度：
- 闲置的: 未开始。
- MKDIR: 创建目标目录。
- 机器人复制: 复制文件数据。
- MKLINK: 创建 Junction 链接。
- 完毕: 完成。

### 3.3 应用数据结构 (应用程序文件夹）

```typescript
interface AppFolder {
  id: string;
  name: string;
  sourcePath: string; // 原路径
  size: string;       // 占用空间
  status: AppStatus;
  moveStep?: MoveStep;
  safetyScore?: number; // AI 评分 (0-100)
  aiAnalysis?: string;  // AI 分析建议
}
```

### 3.4 建议与优化

#### 核心数据模型改进

##### AppStatus 扩展
- **暂停状态**: 添加 `暂停` 状态，允许用户在迁移过程中暂停操作
- **验证状态**: 添加 `验证` 状态，用于验证迁移后的数据完整性

##### MoveStep 扩展
- **验证步骤**: 添加 `验证` 步骤，用于验证文件复制的完整性
- **清理步骤**: 添加 `清理` 步骤，用于处理临时文件或错误恢复

##### AppFolder 扩展
- **目标路径**: 添加 `targetPath: string` 字段，存储迁移目标路径
- **修改时间**: 添加 `lastModified: string` 字段，记录最后修改时间
- **迁移进度**: 添加 `progress: number` 字段，记录迁移进度百分比
- **错误信息**: 添加 `errorMessage?: string` 字段，存储错误详细信息
- **迁移大小**: 添加 `migratedSize?: string` 字段，记录已迁移的数据大小
- **备份路径**: 添加 `backupPath?: string` 字段，存储原始数据的备份路径

##### 新增类型定义
- **迁移配置**: 添加 `MigrationConfig` 类型，存储迁移相关配置
- **日志条目**: 添加 `TerminalLogEntry` 类型，定义终端日志的结构
- **磁盘信息**: 添加 `DiskInfo` 类型，存储磁盘相关信息
- **AI 分析结果**: 添加 `AiAnalysisResult` 类型，更详细地定义 AI 分析结果

```typescript
// 示例新增类型
interface MigrationConfig {
  overwriteExisting: boolean;
  createBackup: boolean;
  verifyAfterMove: boolean;
  parallelExecution: boolean;
}

interface TerminalLogEntry {
  id: string;
  timestamp: string;
  message: string;
  type: 'info' | 'success' | 'warning' | 'error' | 'command';
}

interface DiskInfo {
  id: string;
  name: string;
  path: string;
  totalSpace: string;
  freeSpace: string;
  usedSpace: string;
}

interface AiAnalysisResult {
  riskLevel: 'low' | 'medium' | 'high';
  confidence: number;
  recommendations: string[];
  warnings: string[];
  safeToMove: boolean;
}
```

## 4. 功能模块规范

### 4.1 磁盘与应用扫描
- 数据源: 目前使用 constants.ts 中的模拟应用程序和源驱动器模拟。
- 交互: 切换源磁盘（Source Drive）时触发扫描动画，重置选中状态。

### 4.2 AI 安全分析 (geminiService.ts）
- 触发条件: 用户点击 "Analyze Safety"。
- Prompt 策略: 询问 AI 该文件夹是否包含硬编码路径、是否为系统服务、是否适合做 Junction 链接。
- 输出格式: 强制 JSON Schema 输出，包含 风险等级（低/中/高）和建议采取的行动。
- 容错: 如果 API Key 缺失或请求失败，返回默认的 "Medium Risk" 本地兜底建议。

### 4.3 迁移流程模拟
由于是 Web 环境，实际的 Windows 命令通过 设置超时 模拟延迟，并在终端日志中显示拟真命令：
- MkDir：`mkdir "Target\Path"`
- 机器人复制：`robocopy "源" "目标" /E /COPYALL /MOVE`
- MkLink：`mklink /J "源" "目标"`

### 4.4 终端日志 (终端日志）
- 结构: 包含 ID、时间戳、消息内容、消息类型（info/success/warning/error/command）。
- 用户界面: 自动滚动到底部，命令类型显示为蓝色并带 $ 前缀。

### 4.5 建议与优化

#### 磁盘与应用扫描增强
- **智能排序**: 按大小、名称或类型对应用进行排序
- **过滤功能**: 添加过滤选项，按文件类型或大小范围过滤
- **文件类型分析**: 分析应用文件夹中的文件类型分布
- **磁盘空间预警**: 在磁盘空间不足时提供预警
- **扫描进度**: 显示扫描进度，特别是在扫描大型磁盘时

#### AI 安全分析增强
- **批量分析**: 支持同时分析多个应用文件夹
- **分析历史**: 保存分析历史记录，避免重复分析
- **离线分析模式**: 提供基于本地规则的基本分析，在无网络时使用
- **分析深度**: 允许用户选择分析深度（快速/标准/深度）
- **自定义提示**: 允许高级用户自定义 AI 分析提示

#### 迁移流程增强
- **断点续传**: 支持迁移过程中断后继续
- **并行迁移**: 支持同时迁移多个应用，提高效率
- **迁移回滚**: 在迁移失败时自动回滚到原始状态
- **预检查**: 在迁移前检查目标磁盘空间和权限
- **迁移计划**: 允许用户创建和保存迁移计划
- **增量迁移**: 只迁移修改过的文件，节省时间

#### 终端日志增强
- **日志过滤**: 按类型、时间或关键字过滤日志
- **日志导出**: 支持导出日志为文本文件
- **日志搜索**: 支持在日志中搜索特定内容
- **日志级别控制**: 允许用户调整日志详细程度
- **日志持久化**: 将重要日志保存到本地文件系统

## 5. UI/UX 设计规范

### 5.1 视觉风格
- 主题: 深色模式 (Dark Mode)，背景色 bg-slate-950。
- 主色调: 蓝色 (蓝色-500/蓝色-600) 用于强调和动作按钮。
- 字体: 无衬线字体，代码/路径/日志使用等宽字体 (font-mono）。

### 5.2 窗口模拟
- 标题栏: 自定义实现的 Windows 风格标题栏 (标题栏 组件)，包含模拟的拖拽区域 (WebkitAppRegion: 'drag') 和窗口控制按钮。
- 滚动条: 自定义 CSS Webkit 滚动条，以匹配深色应用风格。

### 5.3 国际化 (i18n)
- 支持语言： 英语 （en）、中文 (zh）。
- 实现方式：translations.ts 字典对象，通过 App.tsx中的状态进行切换。
- 覆盖范围: 界面文本、状态标签、模态框内容。

### 5.4 交互反馈
- 卡片状态：AppCard 根据状态改变边框颜色（绿=完成，蓝=进行中，紫=分析中）。
- 进度细化: 操作面板显示具体的 Checkbox 进度条（创建目录 -> 复制 -> 链接）。

### 5.5 建议与优化

#### 视觉风格优化
- **动态主题切换**: 支持浅色/深色模式自动切换，跟随系统设置
- **品牌色彩系统**: 建立更完整的品牌色彩系统，确保视觉一致性
- **无障碍设计**: 确保界面符合 WCAG 2.1 无障碍标准，支持屏幕阅读器
- **响应式设计**: 优化界面以适应不同屏幕尺寸，从笔记本到桌面显示器

#### 窗口模拟增强
- **窗口大小记忆**: 记住用户上次使用的窗口大小和位置
- **多窗口支持**: 允许打开多个独立窗口，同时处理不同任务
- **托盘图标**: 在系统托盘中添加应用图标，支持最小化到托盘
- **窗口动画**: 添加平滑的窗口过渡动画，提升用户体验

#### 国际化增强
- **语言自动检测**: 自动检测系统语言并切换对应界面语言
- **更完整的翻译**: 确保所有界面元素都有对应的翻译
- **RTL 支持**: 支持从右到左的语言（如阿拉伯语、希伯来语）
- **翻译贡献**: 提供翻译贡献指南，方便社区添加新语言

#### 交互反馈增强
- **动画效果**: 添加更丰富的动画效果，如加载动画、过渡效果
- **声音反馈**: 可选的声音反馈，在重要操作完成时提示
- **操作确认**: 在执行危险操作前添加确认对话框
- **上下文帮助**: 为复杂功能添加上下文帮助和提示
- **快捷键支持**: 添加键盘快捷键，提高操作效率

## 6. 文件目录结构

```
/
├── index.html          # 入口 HTML，包含 Tailwind CDN 和 importmap
├── index.tsx           # React 入口
├── App.tsx             # 主应用逻辑、布局、状态管理
├── types.ts            # TypeScript 类型定义
├── constants.ts        # 模拟数据 (Mock Data) 和配置
├── translations.ts     # 国际化资源文件
├── metadata.json       # 应用元数据
├── services/
│   └── geminiService.ts # Google Gemini API 集成逻辑
└── components/
    ├── AppCard.tsx      # 应用列表卡片组件
    └── TerminalLog.tsx  # 底部日志终端组件
```

### 6.1 建议与优化

#### 目录结构优化
- **模块化组织**: 按功能模块进一步组织代码，如 `features/` 目录
- **工具函数**: 添加 `utils/` 目录，存放通用工具函数
- **hooks**: 添加 `hooks/` 目录，存放自定义 React Hooks
- **样式文件**: 添加 `styles/` 目录，存放全局样式和主题配置
- **assets**: 添加 `assets/` 目录，存放静态资源如图标、图片等
- **config**: 添加 `config/` 目录，存放应用配置
- **tests**: 添加 `tests/` 目录，存放测试文件

```
// 优化后的目录结构示例
/
├── public/             # 静态资源
├── src/
│   ├── index.tsx       # React 入口
│   ├── App.tsx         # 主应用组件
│   ├── types/          # 类型定义
│   │   └── index.ts
│   ├── constants/      # 常量和配置
│   │   └── index.ts
│   ├── services/       # 服务
│   │   ├── geminiService.ts
│   │   └── fileService.ts
│   ├── components/     # 通用组件
│   │   ├── common/
│   │   ├── layout/
│   │   └── widgets/
│   ├── features/       # 功能模块
│   │   ├── diskScan/
│   │   ├── aiAnalysis/
│   │   ├── migration/
│   │   └── terminal/
│   ├── hooks/          # 自定义 Hooks
│   ├── utils/          # 工具函数
│   ├── styles/         # 样式文件
│   └── translations/   # 国际化资源
├── src-tauri/          # Tauri 后端代码
│   ├── src/            # Rust 源代码
│   └── Cargo.toml      # Rust 依赖配置
├── tests/              # 测试文件
├── config/             # 构建配置
└── scripts/            # 脚本文件
```

## 7. 生产环境适配指南 (致原生开发者)

若将本项目打包为 EXE 文件，需进行以下修改：

### 7.1 文件系统访问
- 替换 constants.ts 中的 Mock 数据，使用 Tauri Rust 后端扫描真实磁盘。

### 7.2 命令执行
- 在 App.tsx 的处理移动函数中，移除 设置超时。
- 使用 Tauri 的命令 API 执行真实的 robocopy 和 mklink。
- 需要处理 UAC (管理员权限)，因为创建符号链接通常需要提权。

### 7.3 API 密钥
- 生产环境中 API Key 不应硬编码，应通过后端代理请求或让用户在设置中输入。

### 7.4 建议与优化

#### 生产环境适配详细指南

##### 文件系统访问优化
- **高效扫描**: 使用异步文件系统 API，避免阻塞主线程
- **缓存策略**: 实现文件系统扫描结果缓存，减少重复扫描
- **权限处理**: 妥善处理文件系统权限问题，提供清晰的错误提示
- **磁盘空间监控**: 实时监控磁盘空间变化，避免空间不足导致的问题

##### 命令执行最佳实践
- **管理员权限**: 实现自动请求管理员权限的机制
- **命令输出捕获**: 实时捕获命令执行输出，显示详细进度
- **错误处理**: 完善的错误处理机制，应对各种命令执行失败情况
- **超时处理**: 为长时间运行的命令设置合理的超时机制

##### API 密钥管理
- **环境变量**: 使用环境变量存储 API 密钥
- **配置文件**: 允许用户通过配置文件设置 API 密钥
- **密钥加密**: 对存储的 API 密钥进行加密处理
- **后端代理**: 考虑使用后端代理处理 AI 请求，避免在客户端暴露 API 密钥

##### 性能优化
- **内存管理**: 优化内存使用，避免内存泄漏
- **并行处理**: 合理使用多线程/多进程处理文件操作
- **资源限制**: 设置合理的资源使用限制，避免系统过载
- **启动速度**: 优化应用启动速度，减少初始加载时间

##### 安全性考虑
- **代码签名**: 为应用程序添加数字签名，增强安全性
- **防病毒兼容性**: 确保应用程序不会被防病毒软件误报
- **安全更新**: 实现安全更新机制，及时修复漏洞
- **数据保护**: 确保用户数据在迁移过程中的安全性

##### 错误处理和日志记录
- **详细日志**: 实现详细的日志记录系统，便于调试和问题排查
- **错误恢复**: 实现错误恢复机制，在遇到问题时能够回滚操作
- **用户友好的错误提示**: 提供清晰、有用的错误提示，帮助用户解决问题

##### 部署和更新
- **自动更新**: 实现应用自动更新机制
- **多渠道分发**: 考虑通过 Microsoft Store、GitHub Releases 等多渠道分发应用
- **版本控制**: 实现完善的版本控制机制，确保应用稳定性
- **部署测试**: 在不同 Windows 版本和配置下测试部署

##### 用户体验优化
- **安装向导**: 提供友好的安装向导，引导用户完成安装
- **卸载处理**: 实现完善的卸载处理，清理所有相关文件和注册表项
- **系统集成**: 与 Windows 系统更好地集成，如添加右键菜单选项
- **用户反馈**: 添加用户反馈机制，收集用户意见和建议